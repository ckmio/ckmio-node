{"version":3,"sources":["../src/ckmio-client.js"],"names":["services","auth","chat","topic","funnel","actions","add","send_chat_message","notify","subscribe","unsubscribe","client_ref","replace","c","r","Math","random","v","toString","getHandler","client","type","options","authenticationHandler","topicHandler","funnelHandler","chatHandler","amleneResponseHandler","response","handler","subscriptions","ref","console","log","CkmioClient","host","port","user","password","connection","connecting","planKey","planSecret","delay","handlers","receiveAndDecodeMessage","bind","onConnection","remainding","remaindingLength","throttle","doSubscribe","to","content","formatAndSendMessage","clt_ref","action","payload","from","name","description","updateMessage","plan_key","plan_secret","data","service","stream","when","callback","subscription","conditions","milliseconds","eventname","$this","e","connected","setTimeout","init","login","self","undefined","debug","$waitThenInitEnd","waitThenInit","$waitThenInitError","connectiong","on","connect","str","JSON","parse","message","stringify","dataPacket","packetLength","length","arr","Uint8Array","write","buffer","totalMessageLength","byteLength","accumulatedLen","missingData","slice","byteOffset","slicedMessage","concat","__handleResponse","nextMessageLength","readUInt32BE"],"mappings":"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","file":"ckmio-client.js","sourcesContent":["import { Socket } from 'net';\nimport { Buffer } from 'buffer';\n\n\nexport var services = {\n    auth : \"10\",\n    chat : \"22\",\n    topic : \"21\",\n    funnel: \"27\"\n};\n\nexport var actions = {\n    add : \"add\",\n    send_chat_message: \"send-chat-message\",\n    notify :\"notify\",\n\tsubscribe : \"subscribe\",\n\tunsubscribe : \"unsubscribe\"\n}\n\n\nfunction client_ref(){\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);\n        return v.toString(16);\n  });\n}\n\nfunction getHandler(client, type){\n    switch(type){\n        case(auth):\n            return client.options.authenticationHandler;\n        case(topic):\n            return client.options.topicHandler;\n        case(funnel):\n            return client.options.funnelHandler;\n        case(chat):\n            return client.options.chatHandler;\n        default:\n            return null;\n\n    }\n}\n\nfunction amleneResponseHandler(response, client){\n    let handler = client.subscriptions[response.ref] || getHandler(response.type);\n    if(handler)\n        handler(response);\n    else\n        console.log(`No suitable handler found for this response : {JSON.stringify(response)}`);\n}\n\nexport default class CkmioClient {\n    constructor(options) {\n        this.host = \"ckmio.com\";\n        this.port = 7023;\n        this.options = options;\n        this.user = options.user; \n        this.password = options.password;\n        this.connection = new Socket();\n        this.connecting = false;\n        this.subscriptions = [];\n        this.planKey = options.planKey;\n        this.planSecret = options.planSecret;\n        this.delay = 500;\n        this.handlers = {\n            'data': this.receiveAndDecodeMessage.bind(this),\n            'connect': this.onConnection(),\n        };\n        this.remainding = null;\n        this.remaindingLength = 0;\n    }\n\n    /* start chat handlers */\n    subscribeToChat(handler){\n      this.throttle(()=>this.doSubscribe(services.chat, {}, handler));\n    }\n\n    sendChatMessage(to, content){\n      var ref = client_ref();\n      this.throttle(()=> \n        this.formatAndSendMessage(this.connection, \n            services.chat, \n            {clt_ref: ref, action: actions.send_chat_message, payload : {from : this.user, to : to, content : content }})\n        );\n    }\n    /* end chat handlers */\n\n    /* topic handlers */\n    createTopic(name){\n      var ref = client_ref();\n      this.throttle(()=> this.formatAndSendMessage(this.connection, \n            services.topic, \n            {clt_ref: ref, action: actions.add, payload : {name : name, description : \"Just for us!\"}})\n        );\n    }\n\n    subscribeToTopic(name, handler){\n        this.throttle(()=>this.doSubscribe(services.topic, {name:name}, handler));\n    }\n\n    sendTopicUpdate(name, updateMessage){\n        var ref = client_ref();\n        this.throttle(()=> this.formatAndSendMessage(this.connection, \n              services.topic, \n              {clt_ref: ref, action: actions.notify, payload : {name : name, content : updateMessage}})\n          );\n    }\n\n    login(user, password, planKey, planSecret){\n    \tconsole.log(`I am logging in ${user} - ${password} `)\n        this.formatAndSendMessage(this.connection, services.auth, {action : \"authenticate\", clt_ref: client_ref(), payload: { user: user,  password:password, plan_key : planKey, plan_secret :planSecret} });\n    }\n\n    /* funnels */\n\n    sendToStream(name, data){\n        this.throttle(()=> this.formatAndSendMessage(this.connection, service, {clt_ref: client_ref(), action: actions.add, payload : { stream : name, content: data}}));\n    }\n\n    createStream(name){\n        this.throttle(()=> this.formatAndSendMessage(this.connection, \n            services.funnel, \n            {clt_ref: client_ref(), action: actions.subscribe, payload : {stream : name, description : \"Just for us!\"}})\n        );\n    }\n\n    funnel(name, when, callback){\n        this.throttle(()=>this.doSubscribe(services.funnel, {stream:name, when: when}, callback));\n    }\n\n    \n\n    doSubscribe(service, data, callback){\n        let ref = client_ref();\n        if(callback) this.subscriptions[ref] = callback;\n        this.formatAndSendMessage(this.connection, service, { action : actions.subscribe, payload : data, clt_ref: ref });\n        return ref;\n    }\n\n    unsubscribe(service, ref){\n        var subscription = this.subscriptions[ref];\n        if(subscription!=null)\n            delete subscriptions[ref];\n        this.formatAndSendMessage(this.connection, service, {  action : actions.unsubscribe, clt_ref: ref }); \n    }\n\n    on(subscription, callback){\n        this.throttle(()=>this.subscribe(subscription.conditions, callback));\n    }\n\n\n    waitThenInit(milliseconds, eventname, $this) {\n        return ((e) => {\n            console.log(e); console.log(eventname); $this.connected = false; $this.connecting = true;\n            setTimeout(() => $this.init($this), milliseconds);\n        });\n    }\n\n    onConnection() {\n        var $this = this;\n        return () => { console.log('I am connected \\n'); $this.connected = true; $this.connecting = false; $this.login($this.user, $this.password, $this.planKey, $this.planSecret); }\n    }\n\n    init(self) {\n        var $this = (self == undefined) ? this : self;\n\n        if ($this.connected)\n            return;\n\n\n        if ($this.connecting != true && $this.connection.connecting != true) {\n            if($this.debug){\n            console.log('this.connecting ' + $this.connecting);\n            console.log('this.connection.connecting ' + $this.connection.connecting);\n            }\n\n            var $waitThenInitEnd = $this.waitThenInit(5000, \"end\", $this);\n            var $waitThenInitError = $this.waitThenInit(5000, \"error\", $this);\n            $this.connectiong = true;\n            $this.connection.on('data', $this.handlers['data']);\n            $this.connection.on('end', $waitThenInitEnd);\n            $this.connection.on('error', $waitThenInitError);\n            $this.connection.on('connect', $this.handlers['connect']);\n        }\n\n        if (!$this.connection.connecting) {\n            $this.connection.connect($this.port, $this.host);\n            $this.connecting = true;\n        }\n    }\n\n    __handleResponse(str){\n        if(debug) console.log(\"_handleresponse \\n\"+ str);\n        var r = JSON.parse(str); \n        amleneResponseHandler(r.type, r.clt_ref, r.payload, this);\n    }\n\n    throttle(action){\n      setTimeout(action, this.delay);\n    }\n\n    formatAndSendMessage(connection, service, payload) {\n        var message = service + \":\" + JSON.stringify(payload);\n        var dataPacket = Buffer.from(message);\n        var packetLength = dataPacket.length;\n        var arr = new Uint8Array([\n            (packetLength & 0xff000000) >> 24,\n            (packetLength & 0x00ff0000) >> 16,\n            (packetLength & 0x0000ff00) >> 8,\n            (packetLength & 0x000000ff)\n        ]);\n        connection.write(Buffer.from(arr.buffer)); // writing the size of the packet\n        connection.write(dataPacket);              // writing the actual packet \n    }\n\n    receiveAndDecodeMessage(data){\n        var totalMessageLength = Buffer.byteLength(data);\n        if(this.debug) console.log(\"Total Message Length \" + totalMessageLength);\n        var accumulatedLen = 0;\n        if(this.remainding!=null)\n        {\n            var missingData = new Buffer(data.buffer.slice(data.byteOffset, data.byteOffset + this.remaindingLength));\n            var slicedMessage = Buffer.concat([this.remainding, missingData]);\n            this.__handleResponse(slicedMessage.toString(\"utf8\"));\n            accumulatedLen = this.remaindingLength;\n        }\n        while(totalMessageLength - accumulatedLen > 0){\n            var nextMessageLength = Buffer.from(data.buffer, accumulatedLen, 4).readUInt32BE();\n            if(totalMessageLength - accumulatedLen -nextMessageLength -4 < 0)\n            {\n                this.remainding = new Buffer(data.buffer.slice(data.byteOffset + 4 + accumulatedLen, data.byteOffset + totalMessageLength));\n                this.remaindingLength = -(totalMessageLength - accumulatedLen -nextMessageLength -4);\n                return;\n            }      \n            if(this.debug) console.log(\"Next Message Length \" + nextMessageLength);\n            var slicedMessage = new Buffer(data.buffer.slice(data.byteOffset + 4 + accumulatedLen, data.byteOffset + 4 + accumulatedLen + nextMessageLength));\n            this.__handleResponse(slicedMessage.toString(\"utf8\"));\n            accumulatedLen += nextMessageLength + 4;\n        }\n        this.remainding = null;     \n    }\n\n}\n\n"]}